<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§ˆìŠ¤í„°-ë””í…Œì¼ ê·¸ë¦¬ë“œ</title>
  <script src="ibsheet/ibsheet.js"></script>
  <link rel="stylesheet" href="ibsheet/css/ibsheet.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; }
    .panel { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .panel-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .panel-header h2 { font-size: 1.1rem; color: #333; }
    .panel-body { padding: 15px 20px; }
    .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .btn-primary { background: #1976d2; color: white; }
    .btn-success { background: #388e3c; color: white; }
    .btn-danger { background: #d32f2f; color: white; }
    .btn:hover { opacity: 0.9; }
    .toolbar { display: flex; gap: 8px; }
    .info-text { color: #666; font-size: 13px; }
    .highlight { background: #fff3e0; padding: 2px 8px; border-radius: 4px; }
    .grid-wrapper { display: flex; gap: 20px; }
    .master-panel { flex: 0 0 45%; }
    .detail-panel { flex: 1; }
    @media (max-width: 1200px) {
      .grid-wrapper { flex-direction: column; }
      .master-panel { flex: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="grid-wrapper">
      <!-- ë§ˆìŠ¤í„° ê·¸ë¦¬ë“œ: ì£¼ë¬¸ ëª©ë¡ -->
      <div class="master-panel">
        <div class="panel">
          <div class="panel-header">
            <h2>ğŸ“‹ ì£¼ë¬¸ ëª©ë¡ (ë§ˆìŠ¤í„°)</h2>
            <div class="toolbar">
              <button class="btn btn-sm btn-primary" id="btnRefreshMaster">ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>
          <div class="panel-body">
            <div id="masterSheet" style="width:100%; height:400px;"></div>
          </div>
        </div>
      </div>
      
      <!-- ë””í…Œì¼ ê·¸ë¦¬ë“œ: ì£¼ë¬¸ ìƒì„¸ -->
      <div class="detail-panel">
        <div class="panel">
          <div class="panel-header">
            <h2>
              ğŸ“¦ ì£¼ë¬¸ ìƒì„¸ (ë””í…Œì¼)
              <span class="info-text" id="selectedOrder">- ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”</span>
            </h2>
            <div class="toolbar">
              <button class="btn btn-sm btn-primary" id="btnAddDetail">í•­ëª© ì¶”ê°€</button>
              <button class="btn btn-sm btn-danger" id="btnDeleteDetail">í•­ëª© ì‚­ì œ</button>
              <button class="btn btn-sm btn-success" id="btnSaveDetail">ì €ì¥</button>
            </div>
          </div>
          <div class="panel-body">
            <div id="detailSheet" style="width:100%; height:400px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ìš”ì•½ ì •ë³´ -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸ“Š ì„ íƒ ì£¼ë¬¸ ìš”ì•½</h2>
      </div>
      <div class="panel-body">
        <div style="display:flex; gap:40px;">
          <div>
            <span class="info-text">ì£¼ë¬¸ë²ˆí˜¸:</span>
            <strong id="summaryOrderNo">-</strong>
          </div>
          <div>
            <span class="info-text">ê³ ê°ëª…:</span>
            <strong id="summaryCustomer">-</strong>
          </div>
          <div>
            <span class="info-text">ìƒí’ˆ ìˆ˜:</span>
            <strong id="summaryItemCount">0</strong>ê±´
          </div>
          <div>
            <span class="info-text">ì´ ê¸ˆì•¡:</span>
            <strong id="summaryTotalAmount" class="highlight">0</strong>ì›
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let masterSheet, detailSheet;
    let selectedOrderId = null;
    
    // ìƒ˜í”Œ ë°ì´í„°
    const ordersData = [
      { orderId: "ORD-001", orderDate: "2024-01-15", customerName: "í™ê¸¸ë™", customerPhone: "010-1234-5678", status: "ë°°ì†¡ì¤‘", totalAmount: 125000 },
      { orderId: "ORD-002", orderDate: "2024-01-16", customerName: "ê¹€ì² ìˆ˜", customerPhone: "010-2345-6789", status: "ì¤€ë¹„ì¤‘", totalAmount: 89000 },
      { orderId: "ORD-003", orderDate: "2024-01-17", customerName: "ì´ì˜í¬", customerPhone: "010-3456-7890", status: "ì™„ë£Œ", totalAmount: 256000 },
      { orderId: "ORD-004", orderDate: "2024-01-18", customerName: "ë°•ë¯¼ìˆ˜", customerPhone: "010-4567-8901", status: "ì¤€ë¹„ì¤‘", totalAmount: 45000 },
      { orderId: "ORD-005", orderDate: "2024-01-19", customerName: "ì •ìˆ˜ì§„", customerPhone: "010-5678-9012", status: "ë°°ì†¡ì¤‘", totalAmount: 178000 }
    ];
    
    const orderDetailsData = {
      "ORD-001": [
        { detailId: 1, productName: "ë…¸íŠ¸ë¶", quantity: 1, unitPrice: 100000, amount: 100000 },
        { detailId: 2, productName: "ë§ˆìš°ìŠ¤", quantity: 1, unitPrice: 25000, amount: 25000 }
      ],
      "ORD-002": [
        { detailId: 3, productName: "í‚¤ë³´ë“œ", quantity: 2, unitPrice: 35000, amount: 70000 },
        { detailId: 4, productName: "USB ì¼€ì´ë¸”", quantity: 3, unitPrice: 6333, amount: 19000 }
      ],
      "ORD-003": [
        { detailId: 5, productName: "ëª¨ë‹ˆí„°", quantity: 1, unitPrice: 200000, amount: 200000 },
        { detailId: 6, productName: "HDMI ì¼€ì´ë¸”", quantity: 2, unitPrice: 15000, amount: 30000 },
        { detailId: 7, productName: "ëª¨ë‹ˆí„° ì•”", quantity: 1, unitPrice: 26000, amount: 26000 }
      ],
      "ORD-004": [
        { detailId: 8, productName: "USB í—ˆë¸Œ", quantity: 1, unitPrice: 45000, amount: 45000 }
      ],
      "ORD-005": [
        { detailId: 9, productName: "ì›¹ìº ", quantity: 1, unitPrice: 80000, amount: 80000 },
        { detailId: 10, productName: "ë§ˆì´í¬", quantity: 1, unitPrice: 55000, amount: 55000 },
        { detailId: 11, productName: "ì¡°ëª…", quantity: 1, unitPrice: 43000, amount: 43000 }
      ]
    };
    
    document.addEventListener("DOMContentLoaded", function() {
      initMasterSheet();
      initDetailSheet();
      bindEvents();
      loadMasterData();
    });
    
    function initMasterSheet() {
      IBSheet.create({
        id: "masterSheet",
        el: "masterSheet",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: false
          },
          Cols: [
            { Header: "ì£¼ë¬¸ë²ˆí˜¸", Name: "orderId", Type: "Text", Width: 100 },
            { Header: "ì£¼ë¬¸ì¼", Name: "orderDate", Type: "Date", Width: 100, Align: "Center", Format: "yyyy-MM-dd" },
            { Header: "ê³ ê°ëª…", Name: "customerName", Type: "Text", Width: 80 },
            { Header: "ì—°ë½ì²˜", Name: "customerPhone", Type: "Text", Width: 120 },
            { 
              Header: "ìƒíƒœ", 
              Name: "status", 
              Type: "Text", 
              Width: 70, 
              Align: "Center",
              OnCellStyle: function(row, col, value) {
                const styles = {
                  "ì¤€ë¹„ì¤‘": { Background: "#FFF3E0", Color: "#E65100" },
                  "ë°°ì†¡ì¤‘": { Background: "#E3F2FD", Color: "#1565C0" },
                  "ì™„ë£Œ": { Background: "#E8F5E9", Color: "#2E7D32" }
                };
                return styles[value] || null;
              }
            },
            { Header: "ì´ ê¸ˆì•¡", Name: "totalAmount", Type: "Int", Width: 100, Align: "Right", Format: "#,##0ì›" }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              masterSheet = IBSheet.getSheetById("masterSheet");
            },
            onRowSelect: function(evt) {
              if (evt.row) {
                selectedOrderId = this.getValue(evt.row, "orderId");
                loadDetailData(selectedOrderId);
                updateSummary(evt.row);
              }
            }
          }
        },
        data: []
      });
    }
    
    function initDetailSheet() {
      IBSheet.create({
        id: "detailSheet",
        el: "detailSheet",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: true
          },
          Cols: [
            { Header: "No", Name: "_rowNum", Type: "RowNum", Width: 50, Align: "Center" },
            { Header: "ìƒí’ˆëª…", Name: "productName", Type: "Text", Width: 200, Required: true },
            { Header: "ìˆ˜ëŸ‰", Name: "quantity", Type: "Int", Width: 80, Align: "Right", Min: 1 },
            { Header: "ë‹¨ê°€", Name: "unitPrice", Type: "Int", Width: 100, Align: "Right", Format: "#,##0" },
            { 
              Header: "ê¸ˆì•¡", 
              Name: "amount", 
              Type: "Int", 
              Width: 120, 
              Align: "Right", 
              Format: "#,##0ì›",
              CanEdit: false
            }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              detailSheet = IBSheet.getSheetById("detailSheet");
            },
            onAfterChange: function(evt) {
              // ê¸ˆì•¡ ìë™ ê³„ì‚°
              if (evt.col === "quantity" || evt.col === "unitPrice") {
                const qty = this.getValue(evt.row, "quantity") || 0;
                const price = this.getValue(evt.row, "unitPrice") || 0;
                this.setValue(evt.row, "amount", qty * price);
              }
              updateDetailSummary();
            },
            onAfterRowAdd: function(evt) {
              updateDetailSummary();
            },
            onAfterRowDelete: function(evt) {
              updateDetailSummary();
            }
          }
        },
        data: []
      });
    }
    
    function bindEvents() {
      document.getElementById("btnRefreshMaster").onclick = loadMasterData;
      
      document.getElementById("btnAddDetail").onclick = function() {
        if (!selectedOrderId) {
          alert("ë¨¼ì € ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }
        detailSheet.addRow({
          init: { quantity: 1 },
          focus: true,
          focusCol: "productName"
        });
      };
      
      document.getElementById("btnDeleteDetail").onclick = function() {
        const row = detailSheet.getFocusedRow();
        if (!row) {
          alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }
        if (confirm("ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          detailSheet.deleteRow(row);
        }
      };
      
      document.getElementById("btnSaveDetail").onclick = function() {
        if (!selectedOrderId) {
          alert("ì €ì¥í•  ì£¼ë¬¸ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          return;
        }
        
        const saveData = detailSheet.getSaveJson({ check: 1 });
        if (saveData.data.length === 0) {
          alert("ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        
        console.log("ì €ì¥ ë°ì´í„°:", { orderId: selectedOrderId, details: saveData });
        
        // ì„œë²„ ì €ì¥ í›„
        detailSheet.acceptChanges();
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // ë§ˆìŠ¤í„° ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        updateMasterAmount();
      };
    }
    
    function loadMasterData() {
      masterSheet.loadSearchData({ data: ordersData });
      
      // ìƒì„¸ ì´ˆê¸°í™”
      selectedOrderId = null;
      detailSheet.clearData();
      clearSummary();
    }
    
    function loadDetailData(orderId) {
      const details = orderDetailsData[orderId] || [];
      detailSheet.loadSearchData({ data: details });
      
      document.getElementById("selectedOrder").textContent = `- ${orderId}`;
      updateDetailSummary();
    }
    
    function updateSummary(masterRow) {
      document.getElementById("summaryOrderNo").textContent = 
        masterSheet.getValue(masterRow, "orderId");
      document.getElementById("summaryCustomer").textContent = 
        masterSheet.getValue(masterRow, "customerName");
      updateDetailSummary();
    }
    
    function updateDetailSummary() {
      const rows = detailSheet.getAllRows();
      let totalAmount = 0;
      
      rows.forEach(row => {
        totalAmount += detailSheet.getValue(row, "amount") || 0;
      });
      
      document.getElementById("summaryItemCount").textContent = rows.length;
      document.getElementById("summaryTotalAmount").textContent = totalAmount.toLocaleString();
    }
    
    function updateMasterAmount() {
      if (!selectedOrderId) return;
      
      const masterRow = masterSheet.findRow("orderId", selectedOrderId);
      if (masterRow) {
        let totalAmount = 0;
        detailSheet.getAllRows().forEach(row => {
          totalAmount += detailSheet.getValue(row, "amount") || 0;
        });
        masterSheet.setValue(masterRow, "totalAmount", totalAmount);
      }
    }
    
    function clearSummary() {
      document.getElementById("selectedOrder").textContent = "- ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”";
      document.getElementById("summaryOrderNo").textContent = "-";
      document.getElementById("summaryCustomer").textContent = "-";
      document.getElementById("summaryItemCount").textContent = "0";
      document.getElementById("summaryTotalAmount").textContent = "0";
    }
  </script>
</body>
</html>
