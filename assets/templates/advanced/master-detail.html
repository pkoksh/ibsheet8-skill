<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>마스터-디테일</title>
  <link rel="stylesheet" href="../../../ibsheet/css/default/main.css">
  <script src="../../../ibsheet/ibsheet.js"></script>
  <script src="../../../ibsheet/locale/ko.js"></script>
</head>
<body>
  <!-- 마스터 그리드: 주문 목록 -->
  <div id="masterSheet" style="width:100%;height:250px;"></div>

  <!-- 디테일 그리드: 주문 상세 -->
  <button onclick="addDetail()">항목 추가</button>
  <button onclick="deleteDetail()">항목 삭제</button>
  <button onclick="saveDetail()">저장</button>
  <div id="detailSheet" style="width:100%;height:250px;"></div>

  <script>
    var selectedOrderId = null;

    // 샘플 데이터
    var ordersData = [
      { orderId: "ORD-001", orderDate: "2024-01-15", customerName: "홍길동", status: "배송중", totalAmount: 125000 },
      { orderId: "ORD-002", orderDate: "2024-01-16", customerName: "김철수", status: "준비중", totalAmount: 89000 },
      { orderId: "ORD-003", orderDate: "2024-01-17", customerName: "이영희", status: "완료", totalAmount: 256000 }
    ];

    var orderDetailsData = {
      "ORD-001": [
        { productName: "노트북", quantity: 1, unitPrice: 100000 },
        { productName: "마우스", quantity: 1, unitPrice: 25000 }
      ],
      "ORD-002": [
        { productName: "키보드", quantity: 2, unitPrice: 35000 },
        { productName: "USB 케이블", quantity: 3, unitPrice: 6333 }
      ],
      "ORD-003": [
        { productName: "모니터", quantity: 1, unitPrice: 200000 },
        { productName: "HDMI 케이블", quantity: 2, unitPrice: 15000 },
        { productName: "모니터 암", quantity: 1, unitPrice: 26000 }
      ]
    };

    document.addEventListener("DOMContentLoaded", function() {
      // 마스터 시트
      IBSheet.create({
        id: "masterSheet",
        el: "masterSheet",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: 0
          },
          Cols: [
            { Header: "주문번호", Name: "orderId", Type: "Text", Width: 100 },
            { Header: "주문일", Name: "orderDate", Type: "Date", Width: 100, Align: "Center", Format: "yyyy-MM-dd" },
            { Header: "고객명", Name: "customerName", Type: "Text", Width: 100 },
            { Header: "상태", Name: "status", Type: "Text", Width: 80, Align: "Center" },
            { Header: "총 금액", Name: "totalAmount", Type: "Int", Width: 120, Align: "Right", Format: "#,##0원" }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              evt.sheet.loadSearchData({ data: ordersData });
            },
            onAfterClick: function(evt) {
              if (evt.row) {
                selectedOrderId = evt.sheet.getValue(evt.row, "orderId");
                loadDetailData(selectedOrderId);
              }
            }
          }
        }
      });

      // 디테일 시트
      IBSheet.create({
        id: "detailSheet",
        el: "detailSheet",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: 1
          },
          Def: {
            Row: {
              CanFormula: 1,
              CalcOrder: "amount"
            }
          },
          Cols: [
            { Header: "상품명", Name: "productName", Type: "Text", Width: 200, Required: 1 },
            { Header: "수량", Name: "quantity", Type: "Int", Width: 80, Align: "Right" },
            { Header: "단가", Name: "unitPrice", Type: "Int", Width: 100, Align: "Right", Format: "#,##0" },
            {
              Header: "금액", Name: "amount", Type: "Int", Width: 120, Align: "Right", Format: "#,##0원",
              Formula: function(fr) {
                return (fr.Row["quantity"] || 0) * (fr.Row["unitPrice"] || 0);
              }
            }
          ]
        }
      });
    });

    function loadDetailData(orderId) {
      var detailSheet = window["detailSheet"];
      var details = orderDetailsData[orderId] || [];
      detailSheet.loadSearchData({ data: details });
    }

    function addDetail() {
      if (!selectedOrderId) {
        alert("먼저 주문을 선택하세요.");
        return;
      }
      var detailSheet = window["detailSheet"];
      detailSheet.addRow({ init: { quantity: 1 } });
    }

    function deleteDetail() {
      var detailSheet = window["detailSheet"];
      var row = detailSheet.getFocusedRow();
      if (!row) {
        alert("삭제할 항목을 선택하세요.");
        return;
      }
      if (confirm("이 항목을 삭제하시겠습니까?")) {
        if(row["Added"]) {
          detailSheet.removeRow(row);
        }else{
          detailSheet.deleteRow(row);
        }
      }
    }

    function saveDetail() {
      if (!selectedOrderId) {
        alert("저장할 주문이 선택되지 않았습니다.");
        return;
      }
      var detailSheet = window["detailSheet"];
      detailSheet.doSave({
        url: "/api/orders/detail/save",
        param: { orderId: selectedOrderId },
        quest: 1
      });
    }
  </script>
</body>
</html>
