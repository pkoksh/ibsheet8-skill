<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŠ¸ë¦¬ ê·¸ë¦¬ë“œ</title>
  <script src="ibsheet/ibsheet.js"></script>
  <link rel="stylesheet" href="ibsheet/css/ibsheet.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { padding: 20px; border-bottom: 1px solid #eee; }
    .header h1 { font-size: 1.5rem; color: #333; margin-bottom: 5px; }
    .header p { color: #666; font-size: 14px; }
    .toolbar { padding: 15px 20px; display: flex; gap: 10px; flex-wrap: wrap; border-bottom: 1px solid #eee; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #1976d2; color: white; }
    .btn-success { background: #388e3c; color: white; }
    .btn-danger { background: #d32f2f; color: white; }
    .btn-secondary { background: #757575; color: white; }
    .btn:hover { opacity: 0.9; }
    .grid-container { padding: 20px; }
    .footer { padding: 15px 20px; border-top: 1px solid #eee; color: #666; font-size: 14px; }
    .shortcut { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒ² ì¡°ì§ë„ ê´€ë¦¬</h1>
      <p>ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì¡°ì§ êµ¬ì¡°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <div class="toolbar">
      <button class="btn btn-primary" id="btnExpandAll">ì „ì²´ í¼ì¹˜ê¸°</button>
      <button class="btn btn-primary" id="btnCollapseAll">ì „ì²´ ì ‘ê¸°</button>
      <button class="btn btn-secondary" id="btnExpandLevel2">2ë‹¨ê³„ê¹Œì§€</button>
      <span style="border-left: 1px solid #ddd; margin: 0 10px;"></span>
      <button class="btn btn-primary" id="btnAddRoot">ìµœìƒìœ„ ì¶”ê°€</button>
      <button class="btn btn-primary" id="btnAddChild">í•˜ìœ„ ì¶”ê°€</button>
      <button class="btn btn-danger" id="btnDelete">ì‚­ì œ</button>
      <button class="btn btn-success" id="btnSave" style="margin-left: auto;">ì €ì¥</button>
    </div>
    
    <div class="grid-container">
      <div id="sheetContainer" style="width:100%; height:500px;"></div>
    </div>
    
    <div class="footer">
      <strong>ë‹¨ì¶•í‚¤:</strong>
      <span class="shortcut">Enter</span> í¸ì§‘ ì™„ë£Œ Â· 
      <span class="shortcut">Insert</span> í•˜ìœ„ ë…¸ë“œ ì¶”ê°€ Â· 
      <span class="shortcut">Delete</span> ë…¸ë“œ ì‚­ì œ Â· 
      <span class="shortcut">â†â†’</span> í¼ì¹˜ê¸°/ì ‘ê¸°
    </div>
  </div>

  <script>
    let sheet;
    
    // ìƒ˜í”Œ ì¡°ì§ë„ ë°ì´í„°
    const treeData = [
      { id: 1, parentId: null, name: "ëŒ€í‘œì´ì‚¬", code: "CEO", headcount: 1, budget: 0 },
      { id: 2, parentId: 1, name: "ê²½ì˜ì§€ì›ë³¸ë¶€", code: "MGT", headcount: 15, budget: 500000000 },
      { id: 3, parentId: 2, name: "ì¸ì‚¬íŒ€", code: "HR", headcount: 5, budget: 100000000 },
      { id: 4, parentId: 2, name: "ì¬ë¬´íŒ€", code: "FIN", headcount: 6, budget: 150000000 },
      { id: 5, parentId: 2, name: "ì´ë¬´íŒ€", code: "GA", headcount: 4, budget: 80000000 },
      { id: 6, parentId: 1, name: "ê°œë°œë³¸ë¶€", code: "DEV", headcount: 45, budget: 2000000000 },
      { id: 7, parentId: 6, name: "ê°œë°œ1íŒ€", code: "DEV1", headcount: 15, budget: 600000000 },
      { id: 8, parentId: 6, name: "ê°œë°œ2íŒ€", code: "DEV2", headcount: 15, budget: 600000000 },
      { id: 9, parentId: 6, name: "ê°œë°œ3íŒ€", code: "DEV3", headcount: 10, budget: 400000000 },
      { id: 10, parentId: 6, name: "QAíŒ€", code: "QA", headcount: 5, budget: 200000000 },
      { id: 11, parentId: 1, name: "ì˜ì—…ë³¸ë¶€", code: "SALES", headcount: 25, budget: 800000000 },
      { id: 12, parentId: 11, name: "êµ­ë‚´ì˜ì—…íŒ€", code: "DOM", headcount: 15, budget: 500000000 },
      { id: 13, parentId: 11, name: "í•´ì™¸ì˜ì—…íŒ€", code: "INT", headcount: 10, budget: 300000000 },
      { id: 14, parentId: 1, name: "ë§ˆì¼€íŒ…ë³¸ë¶€", code: "MKT", headcount: 12, budget: 600000000 },
      { id: 15, parentId: 14, name: "ë¸Œëœë“œíŒ€", code: "BRAND", headcount: 5, budget: 300000000 },
      { id: 16, parentId: 14, name: "ë””ì§€í„¸ë§ˆì¼€íŒ…íŒ€", code: "DMKT", headcount: 7, budget: 300000000 }
    ];
    
    document.addEventListener("DOMContentLoaded", function() {
      initSheet();
      bindEvents();
    });
    
    function initSheet() {
      IBSheet.create({
        id: "sheet",
        el: "sheetContainer",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: true,
            TreeMode: true,
            TreeCol: "name",
            TreeIdCol: "id",
            TreeParentCol: "parentId",
            CanDrag: true,
            CanDrop: true
          },
          Cols: [
            { Header: "ID", Name: "id", Type: "Int", Width: 60, CanEdit: false, Hidden: true },
            { Header: "ìƒìœ„ID", Name: "parentId", Type: "Int", Width: 60, Hidden: true },
            { 
              Header: "ì¡°ì§ëª…", 
              Name: "name", 
              Type: "Text", 
              Width: 250,
              Required: true,
              OnCellStyle: function(row, col, value) {
                const level = this.getLevel ? this.getLevel(row) : 0;
                if (level === 0) {
                  return { FontWeight: "bold", Color: "#1565c0" };
                } else if (level === 1) {
                  return { FontWeight: "bold" };
                }
                return null;
              }
            },
            { Header: "ì½”ë“œ", Name: "code", Type: "Text", Width: 80, Align: "Center" },
            { Header: "ì¸ì›", Name: "headcount", Type: "Int", Width: 70, Align: "Right" },
            { Header: "ì˜ˆì‚°", Name: "budget", Type: "Int", Width: 130, Align: "Right", Format: "#,##0ì›" },
            { 
              Header: "ìƒíƒœ", 
              Name: "_STATUS", 
              Type: "Text", 
              Width: 50, 
              Align: "Center",
              CanEdit: false,
              OnCellStyle: function(row, col, value) {
                const styles = {
                  "I": { Background: "#E3F2FD", Color: "#1976D2" },
                  "U": { Background: "#FFF3E0", Color: "#F57C00" },
                  "D": { Background: "#FFEBEE", Color: "#D32F2F" }
                };
                return styles[value] || null;
              }
            }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              sheet = IBSheet.getSheetById("sheet");
              sheet.loadSearchData({ data: treeData });
              sheet.expandAll();
            },
            onBeforeDrop: function(evt) {
              // ë“œë¡­ ì „ ê²€ì¦
              const dragRow = evt.row;
              const targetRow = evt.targetRow;
              
              // ìê¸° ìì‹ ì˜ í•˜ìœ„ë¡œ ì´ë™ ë°©ì§€
              if (targetRow && isDescendant(targetRow, dragRow)) {
                alert("ìê¸° ìì‹ ì˜ í•˜ìœ„ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return false;
              }
              
              return true;
            },
            onAfterDrop: function(evt) {
              // ë“œë¡­ í›„ parentId ì—…ë°ì´íŠ¸
              const row = evt.row;
              const parent = this.getParentRow ? this.getParentRow(row) : null;
              const newParentId = parent ? this.getValue(parent, "id") : null;
              this.setValue(row, "parentId", newParentId);
            },
            onKeyDown: function(evt) {
              // Insert: í•˜ìœ„ ë…¸ë“œ ì¶”ê°€
              if (evt.keyCode === 45) {
                addChildNode();
                return false;
              }
              // Delete: ë…¸ë“œ ì‚­ì œ
              if (evt.keyCode === 46 && !this.isEditing()) {
                deleteNode();
                return false;
              }
            }
          }
        },
        data: []
      });
    }
    
    function isDescendant(row, potentialAncestor) {
      // ìˆœí™˜ ì°¸ì¡° ì²´í¬
      let current = row;
      while (current) {
        if (current === potentialAncestor) return true;
        current = sheet.getParentRow ? sheet.getParentRow(current) : null;
      }
      return false;
    }
    
    function bindEvents() {
      document.getElementById("btnExpandAll").onclick = function() {
        sheet.expandAll();
      };
      
      document.getElementById("btnCollapseAll").onclick = function() {
        sheet.collapseAll();
      };
      
      document.getElementById("btnExpandLevel2").onclick = function() {
        sheet.collapseAll();
        sheet.expandToLevel(2);
      };
      
      document.getElementById("btnAddRoot").onclick = function() {
        const newId = getNextId();
        sheet.addRow({
          init: {
            id: newId,
            parentId: null,
            name: "ìƒˆ ì¡°ì§",
            code: "NEW",
            headcount: 0,
            budget: 0
          },
          focus: true,
          focusCol: "name"
        });
      };
      
      document.getElementById("btnAddChild").onclick = addChildNode;
      
      document.getElementById("btnDelete").onclick = deleteNode;
      
      document.getElementById("btnSave").onclick = function() {
        const saveData = sheet.getSaveJson({ check: 1 });
        
        if (saveData.data.length === 0) {
          alert("ë³€ê²½ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        
        // parentId í¬í•¨í•˜ì—¬ ì €ì¥
        saveData.data.forEach(item => {
          const row = sheet.findRow("id", item.id);
          if (row) {
            const parent = sheet.getParentRow ? sheet.getParentRow(row) : null;
            item.parentId = parent ? sheet.getValue(parent, "id") : null;
          }
        });
        
        console.log("ì €ì¥ ë°ì´í„°:", saveData);
        
        // ì„œë²„ ì €ì¥ í›„
        sheet.acceptChanges();
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      };
    }
    
    function addChildNode() {
      const parentRow = sheet.getFocusedRow();
      if (!parentRow) {
        alert("ìƒìœ„ ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      
      const parentId = sheet.getValue(parentRow, "id");
      const newId = getNextId();
      
      // addChildRowê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì¼ë°˜ addRow
      if (sheet.addChildRow) {
        sheet.addChildRow(parentRow, {
          init: {
            id: newId,
            parentId: parentId,
            name: "ìƒˆ í•˜ìœ„ ì¡°ì§",
            code: "NEW",
            headcount: 0,
            budget: 0
          }
        });
      } else {
        sheet.addRow({
          init: {
            id: newId,
            parentId: parentId,
            name: "ìƒˆ í•˜ìœ„ ì¡°ì§",
            code: "NEW",
            headcount: 0,
            budget: 0
          },
          focus: true,
          focusCol: "name"
        });
      }
      
      // ë¶€ëª¨ ë…¸ë“œ í¼ì¹˜ê¸°
      if (sheet.expand) {
        sheet.expand(parentRow);
      }
    }
    
    function deleteNode() {
      const row = sheet.getFocusedRow();
      if (!row) {
        alert("ì‚­ì œí•  ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      
      // í•˜ìœ„ ë…¸ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
      const children = sheet.getChildRows ? sheet.getChildRows(row) : [];
      if (children.length > 0) {
        if (!confirm("í•˜ìœ„ ì¡°ì§ì´ ìˆìŠµë‹ˆë‹¤. í•¨ê»˜ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }
        // í•˜ìœ„ ë…¸ë“œë„ ì‚­ì œ
        children.forEach(child => sheet.deleteRow(child));
      }
      
      const name = sheet.getValue(row, "name");
      if (confirm(`'${name}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        sheet.deleteRow(row);
      }
    }
    
    function getNextId() {
      let maxId = 0;
      const rows = sheet.getAllRows();
      rows.forEach(row => {
        const id = sheet.getValue(row, "id") || 0;
        if (id > maxId) maxId = id;
      });
      return maxId + 1;
    }
  </script>
</body>
</html>
