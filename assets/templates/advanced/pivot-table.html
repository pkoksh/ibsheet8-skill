<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë²— í…Œì´ë¸”</title>
  <script src="ibsheet/ibsheet.js"></script>
  <link rel="stylesheet" href="ibsheet/css/ibsheet.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .panel { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .panel-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .panel-header h2 { font-size: 1.2rem; color: #333; }
    .panel-body { padding: 20px; }
    .filter-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
    .filter-item { display: flex; align-items: center; gap: 8px; }
    .filter-item label { font-size: 14px; color: #666; }
    .filter-item select, .filter-item input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #1976d2; color: white; }
    .btn-secondary { background: #757575; color: white; }
    .btn:hover { opacity: 0.9; }
    .summary-cards { display: flex; gap: 20px; margin-bottom: 20px; }
    .card { flex: 1; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .card-title { font-size: 13px; color: #666; margin-bottom: 8px; }
    .card-value { font-size: 24px; font-weight: bold; color: #333; }
    .card-value.primary { color: #1976d2; }
    .card-value.success { color: #388e3c; }
    .card-value.warning { color: #f57c00; }
    .legend { display: flex; gap: 20px; margin-top: 15px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
  </style>
</head>
<body>
  <div class="container">
    <!-- í•„í„° ì˜ì—­ -->
    <div class="panel">
      <div class="panel-body">
        <div class="filter-row">
          <div class="filter-item">
            <label>ì—°ë„:</label>
            <select id="filterYear">
              <option value="2024">2024ë…„</option>
              <option value="2023">2023ë…„</option>
            </select>
          </div>
          <div class="filter-item">
            <label>ë¶„ê¸°:</label>
            <select id="filterQuarter">
              <option value="">ì „ì²´</option>
              <option value="Q1">1ë¶„ê¸°</option>
              <option value="Q2">2ë¶„ê¸°</option>
              <option value="Q3">3ë¶„ê¸°</option>
              <option value="Q4">4ë¶„ê¸°</option>
            </select>
          </div>
          <div class="filter-item">
            <label>ì§€ì—­:</label>
            <select id="filterRegion">
              <option value="">ì „ì²´</option>
              <option value="ì„œìš¸">ì„œìš¸</option>
              <option value="ê²½ê¸°">ê²½ê¸°</option>
              <option value="ë¶€ì‚°">ë¶€ì‚°</option>
              <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
            </select>
          </div>
          <button class="btn btn-primary" id="btnApply">ì ìš©</button>
          <button class="btn btn-secondary" id="btnReset">ì´ˆê¸°í™”</button>
          <button class="btn btn-secondary" id="btnExcel" style="margin-left:auto;">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
    </div>
    
    <!-- ìš”ì•½ ì¹´ë“œ -->
    <div class="summary-cards">
      <div class="card">
        <div class="card-title">ì´ ë§¤ì¶œ</div>
        <div class="card-value primary" id="totalSales">0ì›</div>
      </div>
      <div class="card">
        <div class="card-title">ì´ ë¹„ìš©</div>
        <div class="card-value warning" id="totalCost">0ì›</div>
      </div>
      <div class="card">
        <div class="card-title">ìˆœì´ìµ</div>
        <div class="card-value success" id="totalProfit">0ì›</div>
      </div>
      <div class="card">
        <div class="card-title">ì´ìµë¥ </div>
        <div class="card-value" id="profitRate">0%</div>
      </div>
    </div>
    
    <!-- í”¼ë²— í…Œì´ë¸” -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸ“Š ì§€ì—­ë³„ Â· ë¶„ê¸°ë³„ ë§¤ì¶œ í˜„í™©</h2>
      </div>
      <div class="panel-body">
        <div id="pivotSheet" style="width:100%; height:400px;"></div>
        <div class="legend">
          <div class="legend-item">
            <span class="legend-dot" style="background:#e3f2fd;"></span>
            <span>í‰ê·  ì´ìƒ</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot" style="background:#ffebee;"></span>
            <span>í‰ê·  ì´í•˜</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ìƒì„¸ ë°ì´í„° -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸ“‹ ìƒì„¸ ë°ì´í„°</h2>
      </div>
      <div class="panel-body">
        <div id="detailSheet" style="width:100%; height:300px;"></div>
      </div>
    </div>
  </div>

  <script>
    let pivotSheet, detailSheet;
    
    // ìƒ˜í”Œ ì›ë³¸ ë°ì´í„°
    const rawData = [
      // ì„œìš¸
      { region: "ì„œìš¸", quarter: "Q1", sales: 150000000, cost: 90000000 },
      { region: "ì„œìš¸", quarter: "Q2", sales: 180000000, cost: 100000000 },
      { region: "ì„œìš¸", quarter: "Q3", sales: 200000000, cost: 110000000 },
      { region: "ì„œìš¸", quarter: "Q4", sales: 220000000, cost: 120000000 },
      // ê²½ê¸°
      { region: "ê²½ê¸°", quarter: "Q1", sales: 120000000, cost: 75000000 },
      { region: "ê²½ê¸°", quarter: "Q2", sales: 140000000, cost: 85000000 },
      { region: "ê²½ê¸°", quarter: "Q3", sales: 160000000, cost: 95000000 },
      { region: "ê²½ê¸°", quarter: "Q4", sales: 180000000, cost: 105000000 },
      // ë¶€ì‚°
      { region: "ë¶€ì‚°", quarter: "Q1", sales: 80000000, cost: 50000000 },
      { region: "ë¶€ì‚°", quarter: "Q2", sales: 95000000, cost: 58000000 },
      { region: "ë¶€ì‚°", quarter: "Q3", sales: 110000000, cost: 68000000 },
      { region: "ë¶€ì‚°", quarter: "Q4", sales: 125000000, cost: 78000000 },
      // ëŒ€êµ¬
      { region: "ëŒ€êµ¬", quarter: "Q1", sales: 60000000, cost: 38000000 },
      { region: "ëŒ€êµ¬", quarter: "Q2", sales: 72000000, cost: 45000000 },
      { region: "ëŒ€êµ¬", quarter: "Q3", sales: 85000000, cost: 52000000 },
      { region: "ëŒ€êµ¬", quarter: "Q4", sales: 98000000, cost: 60000000 }
    ];
    
    document.addEventListener("DOMContentLoaded", function() {
      initPivotSheet();
      initDetailSheet();
      bindEvents();
      loadData();
    });
    
    function initPivotSheet() {
      IBSheet.create({
        id: "pivotSheet",
        el: "pivotSheet",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: false,
            MergeSheet: 1,
            FooterRow: true
          },
          Cols: [
            { 
              Header: "ì§€ì—­", 
              Name: "region", 
              Type: "Text", 
              Width: 100, 
              Align: "Center",
              Merge: true,
              Footer: "í•©ê³„"
            },
            { 
              Header: "1ë¶„ê¸°", 
              Name: "Q1", 
              Type: "Int", 
              Width: 130, 
              Align: "Right", 
              Format: "#,##0",
              Footer: "SUM"
            },
            { 
              Header: "2ë¶„ê¸°", 
              Name: "Q2", 
              Type: "Int", 
              Width: 130, 
              Align: "Right", 
              Format: "#,##0",
              Footer: "SUM"
            },
            { 
              Header: "3ë¶„ê¸°", 
              Name: "Q3", 
              Type: "Int", 
              Width: 130, 
              Align: "Right", 
              Format: "#,##0",
              Footer: "SUM"
            },
            { 
              Header: "4ë¶„ê¸°", 
              Name: "Q4", 
              Type: "Int", 
              Width: 130, 
              Align: "Right", 
              Format: "#,##0",
              Footer: "SUM"
            },
            { 
              Header: "í•©ê³„", 
              Name: "total", 
              Type: "Int", 
              Width: 150, 
              Align: "Right", 
              Format: "#,##0",
              Footer: "SUM",
              OnCellStyle: function(row, col, value) {
                return { FontWeight: "bold", Background: "#f5f5f5" };
              }
            }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              pivotSheet = IBSheet.getSheetById("pivotSheet");
            },
            onClick: function(evt) {
              // ì…€ í´ë¦­ ì‹œ ìƒì„¸ ë°ì´í„° í•„í„°
              if (evt.col !== "region" && evt.col !== "total") {
                const region = this.getValue(evt.row, "region");
                const quarter = evt.col;
                filterDetailData(region, quarter);
              } else if (evt.col === "region") {
                const region = this.getValue(evt.row, "region");
                filterDetailData(region, null);
              }
            }
          }
        },
        data: []
      });
    }
    
    function initDetailSheet() {
      IBSheet.create({
        id: "detailSheet",
        el: "detailSheet",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: false
          },
          Cols: [
            { Header: "ì§€ì—­", Name: "region", Type: "Text", Width: 100, Align: "Center" },
            { Header: "ë¶„ê¸°", Name: "quarter", Type: "Text", Width: 80, Align: "Center" },
            { Header: "ë§¤ì¶œ", Name: "sales", Type: "Int", Width: 150, Align: "Right", Format: "#,##0ì›" },
            { Header: "ë¹„ìš©", Name: "cost", Type: "Int", Width: 150, Align: "Right", Format: "#,##0ì›" },
            { 
              Header: "ì´ìµ", 
              Name: "profit", 
              Type: "Int", 
              Width: 150, 
              Align: "Right", 
              Format: "#,##0ì›",
              OnCellStyle: function(row, col, value) {
                if (value < 0) {
                  return { Color: "#d32f2f" };
                } else if (value > 50000000) {
                  return { Color: "#388e3c", FontWeight: "bold" };
                }
                return null;
              }
            },
            { 
              Header: "ì´ìµë¥ ", 
              Name: "profitRate", 
              Type: "Float", 
              Width: 100, 
              Align: "Right", 
              Format: "#,##0.0%"
            }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              detailSheet = IBSheet.getSheetById("detailSheet");
            }
          }
        },
        data: []
      });
    }
    
    function bindEvents() {
      document.getElementById("btnApply").onclick = loadData;
      
      document.getElementById("btnReset").onclick = function() {
        document.getElementById("filterYear").value = "2024";
        document.getElementById("filterQuarter").value = "";
        document.getElementById("filterRegion").value = "";
        loadData();
      };
      
      document.getElementById("btnExcel").onclick = function() {
        pivotSheet.exportExcel({
          fileName: "ë§¤ì¶œí˜„í™©_í”¼ë²—_" + new Date().toISOString().slice(0, 10),
          sheetName: "í”¼ë²—í…Œì´ë¸”"
        });
      };
    }
    
    function loadData() {
      const filterQuarter = document.getElementById("filterQuarter").value;
      const filterRegion = document.getElementById("filterRegion").value;
      
      // í•„í„° ì ìš©
      let filteredData = rawData;
      if (filterQuarter) {
        filteredData = filteredData.filter(d => d.quarter === filterQuarter);
      }
      if (filterRegion) {
        filteredData = filteredData.filter(d => d.region === filterRegion);
      }
      
      // í”¼ë²— ë°ì´í„° ìƒì„±
      const pivotData = createPivotData(filteredData);
      pivotSheet.loadSearchData({ data: pivotData });
      
      // ìƒì„¸ ë°ì´í„° ë¡œë“œ
      const detailData = filteredData.map(d => ({
        ...d,
        profit: d.sales - d.cost,
        profitRate: d.sales > 0 ? (d.sales - d.cost) / d.sales : 0
      }));
      detailSheet.loadSearchData({ data: detailData });
      
      // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
      updateSummaryCards(filteredData);
    }
    
    function createPivotData(data) {
      const regions = [...new Set(data.map(d => d.region))];
      const quarters = ["Q1", "Q2", "Q3", "Q4"];
      
      return regions.map(region => {
        const row = { region };
        let total = 0;
        
        quarters.forEach(q => {
          const item = data.find(d => d.region === region && d.quarter === q);
          row[q] = item ? item.sales : 0;
          total += row[q];
        });
        
        row.total = total;
        return row;
      });
    }
    
    function filterDetailData(region, quarter) {
      let filteredData = rawData;
      
      if (region) {
        filteredData = filteredData.filter(d => d.region === region);
      }
      if (quarter) {
        filteredData = filteredData.filter(d => d.quarter === quarter);
      }
      
      const detailData = filteredData.map(d => ({
        ...d,
        profit: d.sales - d.cost,
        profitRate: d.sales > 0 ? (d.sales - d.cost) / d.sales : 0
      }));
      
      detailSheet.loadSearchData({ data: detailData });
    }
    
    function updateSummaryCards(data) {
      const totalSales = data.reduce((sum, d) => sum + d.sales, 0);
      const totalCost = data.reduce((sum, d) => sum + d.cost, 0);
      const totalProfit = totalSales - totalCost;
      const profitRate = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
      
      document.getElementById("totalSales").textContent = totalSales.toLocaleString() + "ì›";
      document.getElementById("totalCost").textContent = totalCost.toLocaleString() + "ì›";
      document.getElementById("totalProfit").textContent = totalProfit.toLocaleString() + "ì›";
      document.getElementById("profitRate").textContent = profitRate.toFixed(1) + "%";
    }
  </script>
</body>
</html>
