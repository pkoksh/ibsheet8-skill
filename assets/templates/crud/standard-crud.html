<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>표준 CRUD 그리드</title>
  <script src="ibsheet/ibsheet.js"></script>
  <link rel="stylesheet" href="ibsheet/css/ibsheet.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { padding: 20px; border-bottom: 1px solid #eee; }
    .header h1 { font-size: 1.5rem; color: #333; }
    .toolbar { padding: 15px 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border-bottom: 1px solid #eee; }
    .search-area { display: flex; gap: 8px; align-items: center; }
    .search-area input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
    .search-area select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
    .btn-group { display: flex; gap: 5px; margin-left: auto; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #1976d2; color: white; }
    .btn-primary:hover { background: #1565c0; }
    .btn-success { background: #388e3c; color: white; }
    .btn-success:hover { background: #2e7d32; }
    .btn-danger { background: #d32f2f; color: white; }
    .btn-danger:hover { background: #c62828; }
    .btn-secondary { background: #757575; color: white; }
    .btn-secondary:hover { background: #616161; }
    .grid-container { padding: 20px; }
    .footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .status { color: #666; font-size: 14px; }
    .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background: white; padding: 30px 50px; border-radius: 8px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>상품 관리</h1>
    </div>
    
    <div class="toolbar">
      <div class="search-area">
        <select id="searchType">
          <option value="name">상품명</option>
          <option value="category">카테고리</option>
          <option value="status">상태</option>
        </select>
        <input type="text" id="searchKeyword" placeholder="검색어 입력">
        <button class="btn btn-primary" id="btnSearch">검색</button>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-primary" id="btnAdd">행 추가</button>
        <button class="btn btn-danger" id="btnDelete">행 삭제</button>
        <button class="btn btn-secondary" id="btnExcel">엑셀</button>
        <button class="btn btn-success" id="btnSave">저장</button>
      </div>
    </div>
    
    <div class="grid-container">
      <div id="sheetContainer" style="width:100%; height:500px;"></div>
    </div>
    
    <div class="footer">
      <div class="status">
        <span>총 <strong id="totalCount">0</strong>건</span>
        <span style="margin-left:20px;">추가: <strong id="addCount">0</strong></span>
        <span style="margin-left:10px;">수정: <strong id="updateCount">0</strong></span>
        <span style="margin-left:10px;">삭제: <strong id="deleteCount">0</strong></span>
      </div>
    </div>
  </div>
  
  <div class="loading" id="loading">
    <div class="loading-content">
      <div>처리 중...</div>
    </div>
  </div>

  <script>
    let sheet;
    
    document.addEventListener("DOMContentLoaded", function() {
      initSheet();
      bindEvents();
      loadData();
    });
    
    function initSheet() {
      IBSheet.create({
        id: "sheet",
        el: "sheetContainer",
        options: {
          Cfg: {
            SearchMode: 0,
            CanEdit: true,
            HeaderCheck: true
          },
          Cols: [
            { Header: "선택", Name: "chk", Type: "CheckBox", Width: 50, CanEdit: true },
            { 
              Header: "상태", 
              Name: "_STATUS", 
              Type: "Text", 
              Width: 50, 
              Align: "Center",
              CanEdit: false,
              OnCellStyle: function(row, col, value) {
                const styles = {
                  "I": { Background: "#E3F2FD", Color: "#1976D2" },
                  "U": { Background: "#FFF3E0", Color: "#F57C00" },
                  "D": { Background: "#FFEBEE", Color: "#D32F2F" }
                };
                return styles[value] || null;
              }
            },
            { Header: "ID", Name: "id", Type: "Int", Width: 60, CanEdit: false, Align: "Center" },
            { Header: "상품코드", Name: "productCode", Type: "Text", Width: 100, Required: true },
            { Header: "상품명", Name: "productName", Type: "Text", Width: 200, Required: true },
            { 
              Header: "카테고리", 
              Name: "category", 
              Type: "Combo", 
              Width: 100,
              ComboCode: "ELEC|CLOTH|FOOD|ETC",
              ComboText: "전자제품|의류|식품|기타"
            },
            { Header: "단가", Name: "price", Type: "Int", Width: 100, Align: "Right", Format: "#,##0" },
            { Header: "수량", Name: "quantity", Type: "Int", Width: 80, Align: "Right", Format: "#,##0" },
            { 
              Header: "합계", 
              Name: "total", 
              Type: "Int", 
              Width: 120, 
              Align: "Right", 
              Format: "#,##0원",
              CanEdit: false,
              OnCellValue: function(row, col) {
                const price = this.getValue(row, "price") || 0;
                const qty = this.getValue(row, "quantity") || 0;
                return price * qty;
              }
            },
            { 
              Header: "상태", 
              Name: "status", 
              Type: "Combo", 
              Width: 80,
              Align: "Center",
              ComboCode: "Y|N",
              ComboText: "판매중|중지"
            },
            { Header: "등록일", Name: "regDate", Type: "Date", Width: 100, Align: "Center", Format: "yyyy-MM-dd" },
            { Header: "비고", Name: "remark", Type: "Text", Width: 150 }
          ],
          Events: {
            onRenderFirstFinish: function(evt) {
              sheet = IBSheet.getSheetById("sheet");
            },
            onAfterChange: function(evt) {
              // 합계 자동 계산
              if (evt.col === "price" || evt.col === "quantity") {
                this.refresh();
              }
              updateStatusCount();
            },
            onAfterRowAdd: function(evt) {
              updateStatusCount();
            },
            onAfterRowDelete: function(evt) {
              updateStatusCount();
            },
            onBeforeRowDelete: function(evt) {
              const name = this.getValue(evt.row, "productName") || "(이름 없음)";
              return confirm(`'${name}' 항목을 삭제하시겠습니까?`);
            }
          }
        },
        data: []
      });
    }
    
    function bindEvents() {
      // 검색
      document.getElementById("btnSearch").onclick = loadData;
      document.getElementById("searchKeyword").onkeydown = function(e) {
        if (e.keyCode === 13) loadData();
      };
      
      // 행 추가
      document.getElementById("btnAdd").onclick = function() {
        sheet.addRow({
          init: {
            category: "ETC",
            status: "Y",
            regDate: new Date().toISOString().slice(0, 10)
          },
          focus: true,
          focusCol: "productCode"
        });
      };
      
      // 행 삭제
      document.getElementById("btnDelete").onclick = function() {
        const checkedRows = sheet.getCheckedRows();
        if (checkedRows.length === 0) {
          alert("삭제할 항목을 선택하세요.");
          return;
        }
        
        if (!confirm(`${checkedRows.length}건을 삭제하시겠습니까?`)) return;
        
        checkedRows.forEach(row => sheet.deleteRow(row));
      };
      
      // 엑셀
      document.getElementById("btnExcel").onclick = function() {
        sheet.exportExcel({
          fileName: "상품목록_" + new Date().toISOString().slice(0, 10),
          sheetName: "상품목록"
        });
      };
      
      // 저장
      document.getElementById("btnSave").onclick = saveData;
    }
    
    function loadData() {
      showLoading();
      
      const searchType = document.getElementById("searchType").value;
      const searchKeyword = document.getElementById("searchKeyword").value;
      
      // 실제로는 서버 호출
      // sheet.loadSearchData({ url: "/api/products", param: { ... } });
      
      // 샘플 데이터
      const sampleData = [
        { id: 1, productCode: "P001", productName: "노트북", category: "ELEC", price: 1500000, quantity: 10, status: "Y", regDate: "2024-01-15", remark: "" },
        { id: 2, productCode: "P002", productName: "마우스", category: "ELEC", price: 35000, quantity: 100, status: "Y", regDate: "2024-01-16", remark: "무선" },
        { id: 3, productCode: "P003", productName: "티셔츠", category: "CLOTH", price: 29000, quantity: 50, status: "Y", regDate: "2024-01-17", remark: "" },
        { id: 4, productCode: "P004", productName: "청바지", category: "CLOTH", price: 59000, quantity: 30, status: "N", regDate: "2024-01-18", remark: "품절" },
        { id: 5, productCode: "P005", productName: "과자세트", category: "FOOD", price: 15000, quantity: 200, status: "Y", regDate: "2024-01-19", remark: "" }
      ];
      
      setTimeout(function() {
        sheet.loadSearchData({ data: sampleData });
        updateStatusCount();
        hideLoading();
      }, 300);
    }
    
    function saveData() {
      // 유효성 검사
      const result = sheet.validate();
      if (!result.valid) {
        alert(result.message);
        sheet.setFocus(result.row, result.col);
        return;
      }
      
      const saveJson = sheet.getSaveJson({ check: 1 });
      
      if (saveJson.data.length === 0) {
        alert("변경된 데이터가 없습니다.");
        return;
      }
      
      if (!confirm(`${saveJson.data.length}건을 저장하시겠습니까?`)) return;
      
      showLoading();
      
      // 실제로는 서버 호출
      // sheet.saveData({ url: "/api/products/save", data: saveJson, ... });
      
      setTimeout(function() {
        sheet.acceptChanges();
        updateStatusCount();
        hideLoading();
        alert("저장되었습니다.");
      }, 500);
    }
    
    function updateStatusCount() {
      const total = sheet.getRowCount();
      const added = sheet.getRowsByStatus("I").length;
      const updated = sheet.getRowsByStatus("U").length;
      const deleted = sheet.getRowsByStatus("D").length;
      
      document.getElementById("totalCount").textContent = total;
      document.getElementById("addCount").textContent = added;
      document.getElementById("updateCount").textContent = updated;
      document.getElementById("deleteCount").textContent = deleted;
    }
    
    function showLoading() {
      document.getElementById("loading").style.display = "flex";
    }
    
    function hideLoading() {
      document.getElementById("loading").style.display = "none";
    }
  </script>
</body>
</html>
